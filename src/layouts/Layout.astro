---
import Navbar from "./Navbar.astro";
import Footer from "./Footer.astro";

export interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;

// Default meta description
const defaultDescription = "Sopladores Monoetapa y Multietapa. Somos los representantes de Continental Industrie en Chile y Latinoamérica";
const metaDescription = description || defaultDescription;

// Canonical URL - uses the configured site URL from astro.config.mjs
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<html lang="es">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B91NRW3VKC"></script>
    <script>
      // TypeScript-safe Google Analytics initialization
      (window as any).dataLayer = (window as any).dataLayer || [];
      function gtag(...args: any[]) {
        if (typeof window === "undefined") return;
        (window as any).dataLayer.push(args);
      }
      gtag('js', new Date());
      gtag('config', 'G-B91NRW3VKC');
    </script>

    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/faviconcba.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={metaDescription} />
    <link rel="canonical" href={canonicalURL} />
    <title>{title}</title>

    <!-- Optimized font loading with font-display swap -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Raleway:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/style/custom.css" />
  </head>
  <body
    class="overflow-hidden overflow-y-auto bg-base dark:bg-base-dark text-accent dark:text-accent-light min-h-screen"
  >
    <Navbar />
    <slot />
    <Footer />
  </body>
  <script>
    // Force the site to always render in light theme.
    // This also overrides any previously-saved "dark" preference in localStorage.
    (function forceLightTheme() {
      document.documentElement.classList.remove("dark");
      try {
        localStorage.setItem("theme", "light");
      } catch {}
    })();
  </script>
  <script>
    const toggleMenu = document.querySelector(
      "[data-toggle-nav]"
    ) as HTMLButtonElement;
    const navbar = document.querySelector("[data-navbar]") as HTMLDivElement;
    const overlayNav = document.querySelector(
      "[data-nav-overlay]"
    ) as HTMLDivElement;
    if (toggleMenu) {
      toggleMenu.addEventListener("click", (e) => {
        e.preventDefault();
        const isOpen = toggleMenu.getAttribute("data-open-nav") === "true";

        if (!isOpen) {
          toggleMenu.setAttribute("data-open-nav", "true");
          navbar.setAttribute("data-is-open", "true");
          overlayNav.setAttribute("data-is-visible", "true");
          document.body.classList.add("!overflow-y-hidden");
        } else {
          toggleMenu.setAttribute("data-open-nav", "false");
          navbar.setAttribute("data-is-open", "false");
          overlayNav.setAttribute("data-is-visible", "false");
          document.body.classList.remove("!overflow-y-hidden");
        }
      });

      navbar.addEventListener("click", () => {
        toggleMenu.setAttribute("data-open-nav", "false");
        navbar.setAttribute("data-is-open", "false");
        overlayNav.setAttribute("data-is-visible", "false");
        document.body.classList.remove("!overflow-y-hidden");
      });

      overlayNav.addEventListener("click", () => {
        toggleMenu.setAttribute("data-open-nav", "false");
        navbar.setAttribute("data-is-open", "false");
        overlayNav.setAttribute("data-is-visible", "false");
        document.body.classList.remove("!overflow-y-hidden");
      });
    }
  </script>
  <script>
    (function () {
      if (typeof window === "undefined" || typeof document === "undefined") return;
      const prefersReducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;
      if (prefersReducedMotion) return;
      if (!("IntersectionObserver" in window)) return;

      const targets = document.querySelectorAll("[data-scroll-blur], main img, main h2, main h3");
      if (!targets.length) return;

      const io = new IntersectionObserver(
        (entries) => {
          for (const entry of entries) {
            const el = entry.target;
            if (!(el instanceof HTMLElement)) continue;
            if (entry.isIntersecting) {
              el.classList.add("scroll-blur-visible");
            } else {
              el.classList.remove("scroll-blur-visible");
            }
          }
        },
        { threshold: 0.15, rootMargin: "0px 0px -10% 0px" }
      );

      targets.forEach((el) => {
        if (!(el instanceof HTMLElement)) return;
        el.classList.add("scroll-blur", "scroll-breeze");
        io.observe(el);
      });
    })();
  </script>
  <script>
    (function () {
      if (typeof window === "undefined" || typeof document === "undefined") return;
      const prefersReducedMotion = window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches;
      if (prefersReducedMotion) return;

      const breezeTargets = document.querySelectorAll(".scroll-breeze");
      if (!breezeTargets.length) return;

      let lastY = window.scrollY;
      let ticking = false;
      const timers = new WeakMap();

      function applyBreeze(shift: number, skew: number) {
        breezeTargets.forEach((node) => {
          const el = node;
          if (!(el instanceof HTMLElement)) return;
          el.style.setProperty("--scroll-breeze-shift", `${shift}px`);
          el.style.setProperty("--scroll-breeze-skew", `${skew}deg`);
          const existing = timers.get(el);
          if (existing) window.clearTimeout(existing);
          const timeout = window.setTimeout(() => {
            el.style.setProperty("--scroll-breeze-shift", "0px");
            el.style.setProperty("--scroll-breeze-skew", "0deg");
            timers.delete(el);
          }, 220);
          timers.set(el, timeout);
        });
      }

      window.addEventListener(
        "scroll",
        () => {
          if (ticking) return;
          ticking = true;
          window.requestAnimationFrame(() => {
            const currentY = window.scrollY;
            const delta = currentY - lastY;
            lastY = currentY;
            const shift = Math.max(-30, Math.min(30, delta * 1.2));
            const skew = Math.max(-4, Math.min(4, delta * 0.15));
            applyBreeze(shift, skew);
            ticking = false;
          });
        },
        { passive: true }
      );
    })();
  </script>
  <script>
    (function () {
      if (typeof window === "undefined" || typeof document === "undefined") return;

      const navLinks = document.querySelectorAll('[data-navbar] a[href^="/#"]');
      if (!navLinks.length) return;

      // Create map of section IDs to nav links
      const sectionMap = new Map();
      navLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;
        const sectionId = href.replace('/#', '');
        const section = document.getElementById(sectionId);
        if (section) {
          sectionMap.set(section, link);
        }
      });

      // Intersection Observer to track active section
      const observerOptions = {
        rootMargin: '-100px 0px -66%',
        threshold: 0
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const link = sectionMap.get(entry.target);
          if (!link) return;

          if (entry.isIntersecting) {
            navLinks.forEach(l => l.classList.remove('nav-active'));
            link.classList.add('nav-active');
          }
        });
      }, observerOptions);

      // Observe all sections
      sectionMap.forEach((link, section) => {
        observer.observe(section);
      });
    })();
  </script>
  <style is:global>
    .scroll-blur {
      --scroll-blur-translate-y: 30px;
      --scroll-breeze-shift: 0px;
      --scroll-breeze-skew: 0deg;
      filter: blur(12px);
      opacity: 0;
      transform: translateY(var(--scroll-blur-translate-y)) translateX(var(--scroll-breeze-shift))
        skewX(var(--scroll-breeze-skew));
      transition: filter 0.6s ease, opacity 0.6s ease, transform 0.6s ease;
    }
    .scroll-blur.scroll-blur-visible {
      filter: blur(0);
      opacity: 1;
      --scroll-blur-translate-y: 0px;
    }
    .scroll-breeze {
      will-change: transform;
    }
    @media (prefers-reduced-motion: reduce) {
      .scroll-blur {
        filter: none !important;
        opacity: 1 !important;
        transform: none !important;
      }
    }
  </style>
</html>
