---
import Layout from "../../../layouts/Layout.astro";
import Container from "../../../components/shared/Container.astro";
import Title2 from "../../../components/shared/Title2.astro";
import Paragraph from "../../../components/shared/Paragraph.astro";
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const PAGE_SIZE = 6;
  const totalPages = Math.ceil(posts.length / PAGE_SIZE);
  return Array.from({ length: totalPages }, (_, i) => ({ params: { page: String(i + 1) } }));
}

const page = Number(Astro.params.page ?? '1');
const PAGE_SIZE = 6;
const posts = (await getCollection('blog')).sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate));
const totalPages = Math.ceil(posts.length / PAGE_SIZE);
const sliceStart = (page - 1) * PAGE_SIZE;
const pagePosts = posts.slice(sliceStart, sliceStart + PAGE_SIZE);
const allTags = Array.from(new Set(posts.flatMap(p => p.data.tags || [])));
---

<Layout title={`Blog · Página ${page}`}>
  <section class="pt-28 md:pt-32">
    <Container size="wide">
      <div class="text-center max-w-2xl mx-auto">
        <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-heading-1">Blog</h1>
        <Paragraph className="mt-3 text-heading-3">Página {page} de {totalPages}</Paragraph>
      </div>
    </Container>
  </section>

  <section class="py-6 md:py-10">
    <Container>
      {allTags.length > 0 && (
        <div class="flex flex-wrap gap-2 justify-center">
          <a href="/blog" class="px-3 py-1 rounded-full border border-box-border bg-box-bg hover:border-primary transition text-sm">Todas</a>
          {allTags.map((t) => (
            <a href={`/blog/tag/${encodeURIComponent(t)}/`} class="px-3 py-1 rounded-full border border-box-border bg-box-bg hover:border-primary transition text-sm">#{t}</a>
          ))}
        </div>
      )}
    </Container>
  </section>

  <section class="py-4 md:py-8">
    <Container>
      <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
        {pagePosts.map(({ data, slug }) => (
          <a href={`/blog/${slug}/`} class="group block rounded-2xl border border-box-border hover:border-primary transition p-5 bg-box-bg">
            {data.heroImage && (
              <img src={data.heroImage} alt={data.title} class="w-full h-44 object-cover rounded-xl mb-4" />
            )}
            <Title2>{data.title}</Title2>
            <Paragraph className="mt-2 text-heading-3">{data.description}</Paragraph>
            <div class="mt-3 text-sm opacity-70">{new Date(data.pubDate).toLocaleDateString()}</div>
          </a>
        ))}
      </div>
    </Container>
  </section>

  {totalPages > 1 && (
    <section class="pb-12">
      <Container>
        <div class="flex justify-center gap-2">
          <a aria-label="Página anterior" class={`px-3 py-1 rounded border ${page === 1 ? 'opacity-40 pointer-events-none' : 'hover:border-primary'}`} href={page === 1 ? undefined : (page - 1 === 1 ? '/blog' : `/blog/page/${page-1}/`)}>
            «
          </a>
          {Array.from({ length: totalPages }, (_, i) => i + 1).map((p) => (
            <a href={p === 1 ? '/blog' : `/blog/page/${p}/`} class={`px-3 py-1 rounded border ${p === page ? 'bg-primary text-accent-light border-primary' : 'hover:border-primary'}`}>{p}</a>
          ))}
          <a aria-label="Página siguiente" class={`px-3 py-1 rounded border ${page === totalPages ? 'opacity-40 pointer-events-none' : 'hover:border-primary'}`} href={page === totalPages ? undefined : `/blog/page/${page+1}/`}>
            »
          </a>
        </div>
      </Container>
    </section>
  )}
</Layout>

